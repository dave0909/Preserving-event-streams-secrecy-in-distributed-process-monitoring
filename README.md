![ProMTEE logo](https://github.com/user-attachments/assets/74a7fe46-ba6a-40fd-9e45-80e458f709e1)

# ProMTEE: Preserving data secrecy for online process monitoring

This repository contains the published prototype of ProMTEE, a framework to preserve data secrecy for online process monitoring. ProMTEE leverages trusted applications running in Intel SGX TEEs to execute control flow and compliance checking monitoring tasks, while hiding sensitive information of the input events.

## Framework Overview

ProMTEE is centered around the Process Vault, Process State Agents, and Event Stream Generators, ensuring secure and efficient online process monitoring.
The Process Vault is the core computational unit of the framework, responsible for securely maintaining and updating the process state. It is implemented as a EGo Trusted Application running within a Intel SGX Trusted Execution Environment (TEE), which guarantees data confidentiality and code integrity. Internally, the Process Vault consists of several components: the Event Dispatcher, which receives and decrypts incoming events, the Process State Manager, which processes these events and updates the process state, and the Process Trackers, which execute monitoring tasks such as control flow validation and compliance verification. Once deployed within the TEE, the Process Vault becomes immutable and resistant to external tampering, ensuring that event data remains protected from unauthorized access.

The Process State Agents act as intermediaries between organizational information systems and the Process Vault. These agents are lightweight GO applications that collect and preprocess event data before securely transmitting it. They retrieve events from the organization’s Event Stream Engine, encrypt them using keys generated within the TEE, and forward them to the Process Vault through a secure channel. To prevent unauthorized data access, the agents also perform periodic attestation verification, ensuring that they are communicating with a legitimate Process Vault instance running within a trusted environment. This verification mechanism relies on cryptographic proofs generated by the TEE, confirming the integrity and authenticity of the monitoring system.

The Event Stream Generators operate at the organizational level and serve as the primary data sources for process monitoring. These components extract event data from business process management systems or enterprise information systems, producing structured event streams that capture process execution details.

## Project Structure

The project structure from the root directory is as follows:

```
Preserving-event-streams-secrecy-in-distributed-process-monitoring/
├── data/
│   ├── BPMN/...
│   ├── input/
│   │   ├── extraction_manifest_bpic2012.json
│   │   ├── extraction_manifest_motivating.json
│   │   ├── extraction_manifest_sepsis.json
│   │   ├── extraction_manifest_traffic.json
│   ├── output/...
│   ├── PLG/...
│   ├── plot/
│   │   ├── plotBarMemory.py
│   │   ├── plotDelay.py
│   │   ├── plotDelayVsArrival.py
│   │   ├── plotMemory.py
│   │   ├── plotMultiBox.py
│   │   ├── plotMultiMemory.py
│   │   ├── plotMultimemoryBroken.py
│   │   ├── plotMultiMemoryGC.py
│   │   ├── plotSimVStee_memory.py
│   │   ├── plotSimVStee.py
│   ├── PNML/
│   │   ├── bpic2012top10alpha.pnml
│   │   ├── motivating.pnml
│   │   ├── sepsis.pnml
│   │   ├── trafficFines.pnml
│   ├── regoConstraints/...
│   ├── xes/
│   │   ├── bpic2012.xes
│   │   ├── motivatingnew.xes
│   │   ├── sepsis.xes
│   │   ├── trafficFines.xes
├── eventStreamGenerator/
│   ├── PLG-2.0.5/...
│   ├── event_stream_from_log.py
│   ├── filter_semplified_event_log.py
│   ├── generate_event_log_from_stream.py
│   ├── main.py
├── processVault/
│   ├── complianceCheckingLogic/
│   │   ├── complianceCheckingLogic.go
│   ├── eventDispatcher/
│   │   ├── eventDispatcher.go
│   ├── processStateManager/
│   │   ├── processStateManager.go
│   │   ├── violations.go
│   ├── workflowLogic/
│   │   ├── workflowLogic.go
├── testConfigurations/
│   ├── simulationMode/
│   │   ├── runBPIC2012_sim.sh
│   │   ├── runMotivating_sim.sh
│   │   ├── runSepsis_sim.sh
│   │   ├── runTrafficTest_sim.sh
│   ├── teeMode/
│   │   ├── runBPIC2012.sh
│   │   ├── runMotivatingTest.sh
│   │   ├── runSepsisTest.sh
│   │   ├── runTrafficTest.sh
│   ├── complianceCheckingLogicUpdate.go
├── utils/
│   ├── attestation/
│   │   ├── attestation.go
│   ├── delayargs/
│   │   ├── delayargs.go
│   ├── eventsubmission/
│   │   ├── eventSubmission.go
│   ├── petrinet/
│   │   ├── .gitignore
│   │   ├── petrinet_test.go
│   │   ├── petrinet.go
│   │   ├── readme.md
│   │   ├── testNet.puml
│   ├── test/
│   │   ├── test.go
│   ├── xes/
│   │   ├── xes
│   │   ├── xes.go
├── .gitattributes
├── .gitignore
├── go.mod
├── main.go
├── private.pem
├── public.pem
├── README.md
```


## Setup
### Dependencies

To set up and run the project, you need to have the following dependencies installed:

- Go (version 1.16 or later)
- Python (version 3.6 or later)
- pm4py (Python library for process mining)
- ego (Edgeless Systems' confidential computing framework)
- Intel SGX enabled CPU (required to run the process vault in non-simulation mode)

### Environment Setup

1. Clone the repository:

   ```sh
   git clone https://github.com/dave0909/Preserving-event-streams-secrecy-in-distributed-process-monitoring.git
   cd Preserving-event-streams-secrecy-in-distributed-process-monitoring
   ```

2. Install Go dependencies:

   ```sh
   go mod tidy
   ```

3. Install Python dependencies:

   ```sh
   pip install pm4py
   ```

4. Set up ego (refer to the official documentation for detailed instructions):

### Docker Image

You can also use our Docker image to run the project. The Docker image contains all the necessary dependencies and configurations to run ProMTEE.

To pull the Docker image, use the following command:

```sh
docker pull dave0909/promtee
```

You can run the Docker container using the following command:

```sh
docker run -it dave0909/promtee
```

## Running the Project
### Bootstrap a Process Vault
> [!IMPORTANT]  
> To run a Process Vault, you need an Intel SGX-enabled machine. Ensure the correct installation of the Intel SGX and EGo SDKs.

To bootstrap a Process Vault instance in the TEE, you need to use the processVaultCompiler.py script. This script fetches the input process specifications and generates the source of the process vault to launch. The command to use the process vault compiler is as follows:
   ```sh
   python3 processVaultCompiler.py ./data/PNML/motivatingreduced.pnml ./workflowLogic/workflowLogic.go ./data/regoConstraints/motivatingConstraints ./complianceCheckingLogic/complianceCheckingLogic.go localhost:6066 data/input/extraction_manifest_motivating.json false true 40000 false 200
   ```
   Parameters for running the process vault:
   - `bpmn_file_path`: The path to the BPMN or PNML file.
   - `output_go_file_path`: The path to the output Go file for the workflow logic.
   - `constraint_folder_path`: The path to the folder containing the Rego constraint files.
   - `output_go_file_path_compliance`: The path to the output Go file for the compliance checking logic.
   - `event_dispatcher_address`: The address to bind the RPC server for the event dispatcher.
   - `extraction_manifest_file_path`: The path to the extraction manifest file.
   - `isInSimulation`: Boolean indicating whether to run in simulation mode.
   - `isInTesting`: Boolean indicating whether to run in test mode.
   - `nEvents`: The number of events to process.
   - `withExternalQueue`: Boolean indicating whether to enable external query.
   - `slidingWindowSize`: The size of the sliding window for event processing.

## Start the process state agent:
To start up a process state agent, navigate to its folder and use the following command.
   ```sh
   cd procesStateAgent
   ego-go run processStateAgent.go localhost:6065 localhost:1234 false true
   ```

   Parameters for running the process state agent:
   - `psaServer`: The address to bind the RPC server.
   - `esgAddress`: The address of the event stream generator.
   - `skippAttestation`: Boolean indicating whether to skip attestation.
   - `testMode`: Boolean indicating whether to run in test mode.

## Start the event stream generator:
To simulate a process engine and generate XES events to be transmitted to the Process Vault, we developed a Python script taking as input an XES event log. You can use it as follows:
   ```sh
   cd eventStreamGenerator
   python3 event_stream_from_log.py ../data/xes/motivatingnew.xes
   ```

   Parameters for running the event stream generator:
   - `log_path`: The path to the XES event log file.

## Running Tests

### Test Configurations

The repository includes scripts for running tests in different modes, located in the `testConfigurations` directory. The available test modes are:

- `simulationMode`: Scripts for running tests in simulation mode.
- `teeMode`: Scripts for running tests in Trusted Execution Environment (TEE) mode.

### Running our tests

To run a test, navigate to the appropriate test mode directory and execute the desired test script. For example, to run the BPIC2012 test in TEE mode:

```sh
cd testConfigurations/teeMode
./runBPIC2012.sh
```

